<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TFA CRM – Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="main.css" />
</head>
<body>
  <!-- ========= BRANDED HEADER ========= -->
  <header class="brand-bar">
    <div class="container">
      <div class="brand" role="banner" aria-label="The Family Advocates CRM Canada">
        <img src="\images\TFA_Logo_Asset 14.png" class="logo" alt="The Family Advocates logo">
        <div class="title">
          <b>The Family Advocates Canada</b>
          <small>Community CRM</small>
        </div>
      </div>
      <nav id="topNav" class="top-nav" aria-label="Primary" style="display:none">
        <div>
          <a href="dashboard.html">Dashboard</a>
          <a href="contacts.html">Contacts</a>
          <a href="volunteer-hours.html">Volunteer Hours</a>
          <a href="#" id="aboutLink">About</a>
        </div>
        <div>
          <button class="logout" onclick="logout()">Log Out</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- ========= MAIN LAYOUT ========= -->
  <div class="shell" role="main">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="card section callout" aria-live="polite">
        <h2>Branding</h2>
        <p>
          This demo uses <span class="tag">Deep Green #063F1E</span> &
          <span class="tag">Heritage Gold #D89F01</span> plus neutrals for
          accessibility and hierarchy.
        </p>
      </div>

      <div class="card section">
        <h2>About</h2>
        <p>
          UI demonstrates: <strong>Admin Sign Up / Login</strong> and
          <strong>Staff Contact Management</strong>. Data is stored locally
          in your browser for demo purposes only.
        </p>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <section class="content">
      <!-- AUTH AREA -->
      <div class="card">
        <h2 class="accent-underline">Access (Admin)</h2>
        <div class="auth-wrap">
          <!-- SIGN UP -->
          <form id="signupForm" class="auth-card" autocomplete="off" aria-labelledby="signupTitle">
            <h3 id="signupTitle">Sign Up</h3>
            <label for="suEmail">Email</label>
            <input id="suEmail" name="email" type="email" required placeholder="admin@tfa.local" />
            <div class="row">
              <div>
                <label for="suPass">Password</label>
                <input id="suPass" name="password" type="password" minlength="6" required placeholder="••••••••" />
              </div>
              <div>
                <label for="suPass2">Confirm</label>
                <input id="suPass2" type="password" minlength="6" required placeholder="••••••••" />
              </div>
            </div>
            <div class="actions">
              <button class="btn btn-primary" type="submit">Create Admin</button>
              <span class="muted" style="color:var(--muted)">Demo only – stored in localStorage</span>
            </div>
            <div id="signupMsg" class="alert" style="display:none"></div>
          </form>

          <!-- LOGIN -->
          <form id="loginForm" class="auth-card" autocomplete="off" aria-labelledby="loginTitle">
            <h3 id="loginTitle">Log In</h3>
            <label for="liEmail">Email</label>
            <input id="liEmail" name="email" type="email" required placeholder="admin@tfa.local" />
            <label for="liPass">Password</label>
            <input id="liPass" name="password" type="password" required placeholder="••••••••" />
            <div class="actions">
              <button class="btn btn-primary" type="submit">Enter CRM</button>
              <button id="clearLoginBtn" class="btn btn-ghost" type="button">Clear</button>
            </div>
            <div id="loginMsg" class="alert" style="display:none"></div>
          </form>
        </div>
      </div>

      <!-- CONTACTS AREA -->
      <div id="contactsCard" class="card" aria-live="polite" style="margin-top:18px; display:none">
        <div class="toolbar">
          <h2 class="accent-underline">Contacts (Staff)</h2>
          <input id="searchBox" class="search" type="search" placeholder="Search name, email, or tag…" aria-label="Search contacts" />
        </div>

        <!-- Add/Edit Form -->
        <form id="contactForm" autocomplete="off" aria-labelledby="contactFormTitle" style="margin-bottom:14px">
          <h3 id="contactFormTitle" style="margin:.25rem 0 .75rem">Add / Edit Contact</h3>
          <div class="row">
            <div>
              <label for="cName">Full Name</label>
              <input id="cName" required placeholder="Jane Doe" />
            </div>
            <div>
              <label for="cRole">Type</label>
              <select id="cRole" required>
                <option value="Participant">Participant</option>
                <option value="Donor">Donor</option>
                <option value="Volunteer">Volunteer</option>
                <option value="Partner">Partner</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="cEmail">Email</label>
              <input id="cEmail" type="email" placeholder="jane@example.org" />
            </div>
            <div>
              <label for="cPhone">Phone</label>
              <input id="cPhone" placeholder="(555) 123-4567" />
            </div>
          </div>
          <label for="cTags">Tags (comma-separated)</label>
          <input id="cTags" placeholder="donor, monthly, 2025 gala" />
          <label for="cNotes">Notes</label>
          <textarea id="cNotes" placeholder="Background, interests, preferences…"></textarea>

          <div class="actions">
            <button class="btn btn-primary" type="submit">Save Contact</button>
            <button id="resetFormBtn" class="btn btn-ghost" type="button">Reset</button>
            <span id="editFlag" class="tag" style="display:none">Editing</span>
          </div>
        </form>

        <!-- Table -->
        <div id="tableWrap"></div>
      </div>
    </section>
  </div>

  <footer>
    <small>
      Demo only. 
    </small>
  </footer>

  <script>
    // ============== Simple Local "Auth" (Demo) ==============
    const LS_KEYS = {
      admin: "tfa_admin",
      session: "tfa_session",
      contacts: "tfa_contacts_v1"
    };

    const $ = sel => document.querySelector(sel);
    const signupForm = $("#signupForm");
    const loginForm = $("#loginForm");
    const signupMsg = $("#signupMsg");
    const loginMsg = $("#loginMsg");
    const contactsCard = $("#contactsCard");
    const topNav = document.getElementById("topNav");
    const clearLoginBtn = $("#clearLoginBtn");

    const contactForm = $("#contactForm");
    const searchBox = $("#searchBox");
    const tableWrap = $("#tableWrap");
    const editFlag = $("#editFlag");
    const resetFormBtn = $("#resetFormBtn");

    let editingId = null;

    function setMsg(el, text){
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(()=> el.style.display='none', 3000);
    }

    function getAdmin(){ try{ return JSON.parse(localStorage.getItem(LS_KEYS.admin)) }catch{ return null } }
    function setAdmin(obj){ localStorage.setItem(LS_KEYS.admin, JSON.stringify(obj)) }

    function getSession(){ return localStorage.getItem(LS_KEYS.session) }
    function setSession(email){ localStorage.setItem(LS_KEYS.session, email) }
    function clearSession(){ localStorage.removeItem(LS_KEYS.session) }

    function hash(str){
      // lightweight hash for demo only (UPDATE ASAP)
      let h = 0; for (let i=0;i<str.length;i++) h = (h<<5) - h + str.charCodeAt(i) | 0;
      return String(h);
    }

    signupForm.addEventListener("submit", e=>{
      e.preventDefault();
      const email = $("#suEmail").value.trim().toLowerCase();
      const p1 = $("#suPass").value;
      const p2 = $("#suPass2").value;

      if(p1 !== p2){ setMsg(signupMsg, "Passwords do not match."); return }
      setAdmin({ email, passHash: hash(p1), createdAt: Date.now() });
      setMsg(signupMsg, "Admin created. You can now log in.");
      signupForm.reset();
    });

    loginForm.addEventListener("submit", e=>{
      e.preventDefault();
      const admin = getAdmin();
      if(!admin){ setMsg(loginMsg, "No admin exists yet. Please sign up first."); return }

      const email = $("#liEmail").value.trim().toLowerCase();
      const pass = $("#liPass").value;
      if(email === admin.email && hash(pass) === admin.passHash){
        setSession(email);
        setMsg(loginMsg, "Welcome! Access granted.");
        //revealCRM(true);
        window.location.href = "dashboard.html";
      } else {
        setMsg(loginMsg, "Invalid credentials.");
        // Clear only passwords, keep email
        $("#liPass").value = "";
        $("#suPass").value = "";
        $("#suPass2").value = "";
      }
    });

    // Clear login form button
    clearLoginBtn.addEventListener("click", ()=>{
      $("#liEmail").value = "";
      $("#liPass").value = "";
      $("#suEmail").value = "";
      $("#suPass").value = "";
      $("#suPass2").value = "";
      setMsg(loginMsg, "Form cleared.");
    });

    // Logout function for the top nav button
    window.logout = function(){
      clearSession();
      revealCRM(false);
      setMsg(loginMsg, "Logged out.");
    };

    function revealCRM(visible){
      contactsCard.style.display = visible ? "block" : "none";
      if(topNav) topNav.style.display = visible ? "flex" : "none";
    }

    // On load - check for session and show appropriate content
    const hasSession = !!getSession();
    revealCRM(hasSession);
    
    // If user is already logged in, redirect to dashboard
    if (hasSession) {
        console.log("User is already logged in, redirecting to dashboard...");
        window.location.href = "dashboard.html";
    }

    // ============== Contacts (CRUD in localStorage) ==============
    function readContacts(){
      try{ return JSON.parse(localStorage.getItem(LS_KEYS.contacts)) ?? [] }
      catch{ return [] }
    }
    function writeContacts(list){
      localStorage.setItem(LS_KEYS.contacts, JSON.stringify(list));
      renderTable();
    }
    function uid(){ return Math.random().toString(36).slice(2,9) }

    function upsertContact(data){
      const list = readContacts();
      if(editingId){
        const idx = list.findIndex(x=>x.id===editingId);
        if(idx>-1){ list[idx] = {...list[idx], ...data}; }
        editingId = null;
      }else{
        list.push({ id: uid(), ...data });
      }
      writeContacts(list);
      contactForm.reset();
      editFlag.style.display = "none";
      $("#contactFormTitle").textContent = "Add / Edit Contact";
    }

    function deleteContact(id){
      const list = readContacts().filter(x=>x.id!==id);
      writeContacts(list);
    }

    function startEdit(id){
      const item = readContacts().find(x=>x.id===id);
      if(!item) return;
      $("#cName").value = item.name ?? "";
      $("#cRole").value = item.role ?? "Participant";
      $("#cEmail").value = item.email ?? "";
      $("#cPhone").value = item.phone ?? "";
      $("#cTags").value = (item.tags ?? []).join(", ");
      $("#cNotes").value = item.notes ?? "";
      editingId = id;
      editFlag.style.display = "inline-block";
      $("#contactFormTitle").textContent = "Editing Contact";
      window.scrollTo({top: contactForm.offsetTop - 16, behavior: 'smooth'});
    }

    contactForm.addEventListener("submit", e=>{
      e.preventDefault();
      const data = {
        name: $("#cName").value.trim(),
        role: $("#cRole").value,
        email: $("#cEmail").value.trim(),
        phone: $("#cPhone").value.trim(),
        tags: $("#cTags").value.split(",").map(s=>s.trim()).filter(Boolean),
        notes: $("#cNotes").value.trim(),
        updatedAt: Date.now()
      };
      if(!data.name){ alert("Name is required."); return }
      upsertContact(data);
    });

    resetFormBtn.addEventListener("click", ()=>{
      contactForm.reset(); editingId=null; editFlag.style.display="none";
      $("#contactFormTitle").textContent = "Add / Edit Contact";
    });

    function renderTable(){
      const q = (searchBox.value || "").toLowerCase();
      const rows = readContacts()
        .filter(c=>{
          const blob = `${c.name} ${c.email} ${c.phone} ${c.role} ${(c.tags||[]).join(" ")}`.toLowerCase();
          return blob.includes(q);
        })
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      if(rows.length === 0){
        tableWrap.innerHTML = `<div class="empty">No contacts yet. Use the form above to add one.</div>`;
        return;
      }

      const html = `
        <table aria-describedby="contact-table-caption">
          <caption id="contact-table-caption" style="position:absolute; left:-9999px">Contacts table</caption>
          <thead>
            <tr>
              <th style="width:22%">Name</th>
              <th style="width:12%">Type</th>
              <th style="width:22%">Email</th>
              <th style="width:16%">Phone</th>
              <th>Tags</th>
              <th style="width:140px">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${escapeHtml(r.name||"")}</td>
                <td><span class="tag">${escapeHtml(r.role||"")}</span></td>
                <td>${escapeHtml(r.email||"")}</td>
                <td>${escapeHtml(r.phone||"")}</td>
                <td>${(r.tags||[]).map(t=>`<span class="tag" style="margin-right:6px">${escapeHtml(t)}</span>`).join("")}</td>
                <td>
                  <button class="btn btn-ghost" onclick="startEdit('${r.id}')">Edit</button>
                  <button class="btn btn-danger" onclick="confirmDelete('${r.id}')">Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      tableWrap.innerHTML = html;
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    }

    window.startEdit = startEdit;
    window.confirmDelete = function(id){
      if(confirm("Delete this contact?")) deleteContact(id);
    };

    searchBox.addEventListener("input", renderTable);

    // Populate with an example row the first time
    if(readContacts().length === 0){
      writeContacts([
        { id: uid(), name:"Alex Rivera", role:"Donor", email:"alex@donors.org", phone:"555-0102", tags:["monthly","newsletter"], notes:"Prefers email updates", updatedAt: Date.now() }
      ]);
    } else {
      renderTable();
    }
  </script>
</body>
</html>
