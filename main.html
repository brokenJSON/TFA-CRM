<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TFA CRM – Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <!-- HEADER -->
  <header class="brand-bar">
    <div class="container">
      <div class="brand" role="banner" aria-label="The Family Advocates CRM Canada">
        <img src="/images/TFA_Logo_Asset 14.png" class="logo" alt="The Family Advocates logo">
        <div class="title">
          <b>The Family Advocates Canada</b>
          <small>Community CRM</small>
        </div>
      </div>
      <nav id="topNav" class="top-nav" aria-label="Primary" style="display:none">
        <div>
          <a href="dashboard.html">Dashboard</a>
          <a href="contacts.html">Contacts</a>
          <a href="volunteer-hours.html">Volunteer Hours</a>
          <a href="#" id="aboutLink">About</a>
        </div>
        <div>
          <button class="logout" onclick="logout()">Log Out</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- LAYOUT -->
  <div class="shell" role="main">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="card section callout" aria-live="polite">
        <h2>Welcome</h2>
        <p>This is the public landing page. Volunteers can register or log in to record hours.</p>
        <div class="cta-row">
          <button id="openAdminBtn" class="btn btn-ghost" type="button">Admin Login</button>
        </div>
      </div>

      <div class="card section">
        <h2>About</h2>
        <p>Demo only (no server). Data is stored locally in your browser.</p>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <section class="content">
      <!-- VOLUNTEER REGISTER -->
      <div class="card" id="volunteerRegisterCard">
        <h2 class="accent-underline">Volunteer Registration</h2>
        <p class="muted" style="margin-top:-6px">New here? Create your volunteer account.</p>

        <form id="volForm" autocomplete="off" aria-labelledby="volTitle">
          <h3 id="volTitle" style="margin:.25rem 0 .75rem">Tell us about you</h3>

          <div class="row">
            <div>
              <label for="vName">Full Name</label>
              <input id="vName" required placeholder="Jane Doe" />
            </div>
            <div>
              <label for="vEmail">Email</label>
              <input id="vEmail" type="email" required placeholder="jane@example.org" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="vPhone">Phone</label>
              <input id="vPhone" placeholder="(555) 123-4567" />
            </div>
            <div>
              <label for="vAvailability">Availability</label>
              <select id="vAvailability">
                <option value="">Choose…</option>
                <option>Weekdays</option>
                <option>Weeknights</option>
                <option>Weekends</option>
                <option>Flexible</option>
              </select>
            </div>
          </div>

          <label for="vInterests">Interests (comma-separated)</label>
          <input id="vInterests" placeholder="events, outreach, admin" />

          <label for="vNotes">Notes</label>
          <textarea id="vNotes" placeholder="Anything we should know?"></textarea>

          <div class="row">
            <div>
              <label for="vPass">Create Password</label>
              <input id="vPass" type="password" minlength="4" required placeholder="••••" />
            </div>
            <div>
              <label for="vPass2">Confirm Password</label>
              <input id="vPass2" type="password" minlength="4" required placeholder="••••" />
            </div>
          </div>

          <div class="actions">
            <label for="vConsent" style="font-weight:normal">
              <input type="checkbox" id="vConsent" required>
              I consent to be contacted about volunteer opportunities.
            </label>
          </div>

          <div class="actions">
            <button class="btn btn-primary" type="submit">Register as Volunteer</button>
            <button class="btn btn-ghost" type="reset">Reset</button>
          </div>

          <div id="volMsg" class="alert"></div>
        </form>
      </div>

      <!-- VOLUNTEER LOGIN -->
      <div class="card" id="volunteerLoginCard" style="margin-top:18px">
        <h2 class="accent-underline">Volunteer Login</h2>
        <p class="muted" style="margin-top:-6px">Already registered? Log in to record your hours.</p>

        <form id="volLoginForm" autocomplete="off">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" required placeholder="jane@example.org" />

          <label for="loginPass">Password</label>
          <input id="loginPass" type="password" required placeholder="••••" />

          <div class="actions" style="margin-top:10px">
            <button class="btn btn-primary" type="submit">Log In</button>
          </div>

          <div id="loginMsg" class="alert"></div>
        </form>
      </div>

      <!-- HOURS CALENDAR (hidden until volunteer logs in) -->
      <div class="card" id="hoursCard" style="margin-top:18px; display:none">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
          <div>
            <h2 class="accent-underline" style="margin:0">My Volunteer Hours</h2>
            <small class="muted" id="whoAmI"></small>
          </div>
          <div>
            <button id="logoutVolunteerBtn" class="btn btn-ghost" type="button">Log Out</button>
          </div>
        </div>

        <div class="calendar">
          <div class="cal-head">
            <button id="prevMonth" class="btn btn-ghost" type="button">◀ Prev</button>
            <div id="monthLabel" style="font-weight:800"></div>
            <button id="nextMonth" class="btn btn-ghost" type="button">Next ▶</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th>
                <th>Thu</th><th>Fri</th><th>Sat</th>
              </tr>
            </thead>
            <tbody id="calBody"></tbody>
          </table>

          <div class="note">
            Click a date to add/update hours. Numbers only (e.g., 2 or 3.5).  
            <div id="monthTotal" style="margin-top:6px; font-weight:700"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer><small>Demo only.</small></footer>

  <!-- Admin Login Modal -->
  <dialog id="adminDialog" aria-labelledby="adminDialogTitle">
    <div class="modal-card">
      <h3 id="adminDialogTitle">Admin Login</h3>
      <p class="muted" style="margin-top:-4px">Enter your admin credentials to access the dashboard.</p>

      <form id="adminLoginForm" method="dialog" autocomplete="off" style="margin-top:8px">
        <label for="adUser">Username</label>
        <input id="adUser" required placeholder="admin" />

        <label for="adPass">Password</label>
        <input id="adPass" type="password" required placeholder="••••••••" />

        <div id="adminMsg" class="alert"></div>

        <div class="modal-actions">
          <button type="button" id="closeAdminBtn" class="btn btn-ghost">Cancel</button>
          <button type="submit" class="btn btn-primary">Log In</button>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    // ========== Storage keys ==========
    const LS = {
      adminSession: "tfa_session",
      volunteers: "tfa_volunteer_submissions",
      contacts: "tfa_contacts_v1",
      volSession: "tfa_volunteer_session",   // stores logged-in volunteer email
      volHours: "tfa_volunteer_hours"        // map: { [email]: { "YYYY-MM-DD": number } }
    };

    // ========== Helpers ==========
    const $ = s => document.querySelector(s);
    function show(el){ el.style.display = "block"; }
    function hide(el){ el.style.display = "none"; }

    function setAlert(el, text){
      text = (text || "").trim();
      if (text) { el.textContent = text; el.style.display = "block"; }
      else { el.textContent = ""; el.style.display = "none"; }
    }

    function readVolunteers(){ try{ return JSON.parse(localStorage.getItem(LS.volunteers)) || []; }catch{ return []; } }
    function writeVolunteers(list){ localStorage.setItem(LS.volunteers, JSON.stringify(list)); }
    function readContacts(){ try{ return JSON.parse(localStorage.getItem(LS.contacts)) || []; }catch{ return []; } }
    function writeContacts(list){ localStorage.setItem(LS.contacts, JSON.stringify(list)); }
    

    function readHoursMap(){ try{ return JSON.parse(localStorage.getItem(LS.volHours)) || {}; }catch{ return {}; } }
    function writeHoursMap(map){ localStorage.setItem(LS.volHours, JSON.stringify(map)); }

    function hash(str){ // simple demo hash
      let h = 0; for (let i=0;i<str.length;i++) h = (h<<5) - h + str.charCodeAt(i) | 0;
      return String(h);
    }

    // ========== Admin Modal ==========
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "admin";

    const adminDialog   = $("#adminDialog");
    const openAdminBtn  = $("#openAdminBtn");
    const closeAdminBtn = $("#closeAdminBtn");
    const adminForm     = $("#adminLoginForm");
    const adminMsg      = $("#adminMsg");

    openAdminBtn.addEventListener("click", () => {
      setAlert(adminMsg, "");
      $("#adUser").value = "";
      $("#adPass").value = "";
      adminDialog.showModal();
      setTimeout(() => $("#adUser").focus(), 50);
    });
    closeAdminBtn.addEventListener("click", () => adminDialog.close());

    adminForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const u = ($("#adUser").value || "").trim();
      const p = $("#adPass").value || "";
      if (u === ADMIN_USER && p === ADMIN_PASS) {
        localStorage.setItem(LS.adminSession, u);
        setAlert(adminMsg, "Access granted. Redirecting…");
        adminDialog.close();
        window.location.href = "dashboard.html";
      } else {
        setAlert(adminMsg, "Invalid credentials.");
      }
    });

    // ========== Volunteer Register ==========
    const volForm = $("#volForm");
    const volMsg  = $("#volMsg");

    volForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = $("#vName").value.trim();
      const email = $("#vEmail").value.trim().toLowerCase();
      const phone = $("#vPhone").value.trim();
      const availability = $("#vAvailability").value.trim();
      const interests = String($("#vInterests").value || "").split(",").map(s=>s.trim()).filter(Boolean);
      const notes = $("#vNotes").value.trim();
      const pass = $("#vPass").value;
      const pass2 = $("#vPass2").value;
      const consent = $("#vConsent").checked;

      if (!name || !email){ setAlert(volMsg, "Please enter your name and a valid email."); return; }
      if (!consent){ setAlert(volMsg, "Please consent to be contacted so we can follow up."); return; }
      if (pass.length < 4){ setAlert(volMsg, "Password must be at least 4 characters."); return; }
      if (pass !== pass2){ setAlert(volMsg, "Passwords do not match."); return; }

      const list = readVolunteers();
      if (list.some(v => (v.email||"").toLowerCase() === email)){
        setAlert(volMsg, "That email is already registered. Please log in below.");
        return;
      }

      list.push({
        name, email, phone, availability, interests, notes,
        consent: true, submittedAt: Date.now(), passHash: hash(pass)
      });
      writeVolunteers(list);
// --- sync to Contacts (CRM) so admins can see this volunteer ---
(function syncVolunteerToContacts(){
  const contacts = readContacts();
  const ix = contacts.findIndex(c => (c.email||"").toLowerCase() === email);
  const contact = {
    id: Math.random().toString(36).slice(2,9),
    name, email, phone,
    role: "Volunteer",
    tags: Array.from(new Set([...(interests||[]), "volunteer"])),
    notes,
    updatedAt: Date.now()
  };
  if (ix >= 0) {
    // update existing contact minimally
    contacts[ix] = { ...contacts[ix], ...contact, id: contacts[ix].id || contact.id };
  } else {
    contacts.push(contact);
  }
  writeContacts(contacts);
})();

setAlert(volMsg, "Thanks for registering! You can now log in below.");
volForm.reset();
});

    // ========== Volunteer Login + Session ==========
    const volLoginForm = $("#volLoginForm");
    const loginMsg = $("#loginMsg");

    function setVolunteerSession(email){
      localStorage.setItem(LS.volSession, email);
    }
    function getVolunteerSession(){
      return localStorage.getItem(LS.volSession);
    }
    function clearVolunteerSession(){
      localStorage.removeItem(LS.volSession);
    }

    volLoginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = $("#loginEmail").value.trim().toLowerCase();
      const pass  = $("#loginPass").value;

      const vol = readVolunteers().find(v => (v.email||"").toLowerCase() === email);
      if (!vol){ setAlert(loginMsg, "No account found for that email. Please register above."); return; }
      if (vol.passHash !== hash(pass)){ setAlert(loginMsg, "Incorrect password."); return; }

      setVolunteerSession(email);
      setAlert(loginMsg, "Welcome! Loading your calendar…");
      renderAppState();
    });

    $("#logoutVolunteerBtn").addEventListener("click", () => {
      clearVolunteerSession();
      renderAppState();
    });

    // ========== Calendar + Hours ==========
    const calBody = $("#calBody");
    const monthLabel = $("#monthLabel");
    const monthTotal = $("#monthTotal");
    const whoAmI = $("#whoAmI");
    let viewYear, viewMonth; // month is 0..11

    $("#prevMonth").addEventListener("click", () => {
      viewMonth--; if (viewMonth < 0){ viewMonth = 11; viewYear--; }
      drawCalendar();
    });
    $("#nextMonth").addEventListener("click", () => {
      viewMonth++; if (viewMonth > 11){ viewMonth = 0; viewYear++; }
      drawCalendar();
    });

    function pad(n){ return String(n).padStart(2, "0"); }
    function dateKey(y, m, d){ return `${y}-${pad(m+1)}-${pad(d)}`; }

    function getUserHoursMap(email){
      const map = readHoursMap();
      return map[email] || {};
    }
    function setUserHours(email, key, hours){
      const map = readHoursMap();
      if (!map[email]) map[email] = {};
      if (hours === null){ delete map[email][key]; }
      else { map[email][key] = hours; }
      writeHoursMap(map);
    }

    function drawCalendar(){
      const sessionEmail = getVolunteerSession();
      const hoursMap = getUserHoursMap(sessionEmail);

      const first = new Date(viewYear, viewMonth, 1);
      const last  = new Date(viewYear, viewMonth + 1, 0);
      const today = new Date();
      const isThisMonth = (viewYear === today.getFullYear() && viewMonth === today.getMonth());
      monthLabel.textContent = first.toLocaleString(undefined, { month: "long", year: "numeric" });

      // Build rows
      let html = "";
      let dow = first.getDay(); // 0..6 starting Sun
      let cells = [];

      // leading blanks
      for (let i=0;i<dow;i++) cells.push({ empty:true });

      // month days
      for (let d=1; d<=last.getDate(); d++){
        const key = dateKey(viewYear, viewMonth, d);
        cells.push({ day:d, key, hours: hoursMap[key] });
      }

      // trailing blanks to complete last row
      while (cells.length % 7 !== 0) cells.push({ empty:true });

      // render 7 per row
      let monthlyTotal = 0;
      for (let i=0;i<cells.length;i++){
        if (i % 7 === 0) html += "<tr>";
        const c = cells[i];
        if (c.empty){
          html += "<td></td>";
        } else {
          const isToday = isThisMonth && (c.day === today.getDate());
          const hoursBadge = (c.hours != null)
            ? `<div class="hours">${c.hours} hr${Number(c.hours)===1?"":"s"}</div>`
            : "";
          if (c.hours) monthlyTotal += Number(c.hours) || 0;
          html += `
            <td class="${isToday ? "is-today" : ""}" data-key="${c.key}">
              <div class="day-num">${c.day}</div>
              ${hoursBadge}
            </td>
          `;
        }
        if (i % 7 === 6) html += "</tr>";
      }

      calBody.innerHTML = html;
      monthTotal.textContent = `Total this month: ${monthlyTotal} hour${monthlyTotal===1?"":"s"}`;

      // click handler for day cells
      Array.from(calBody.querySelectorAll("td[data-key]")).forEach(td=>{
        td.addEventListener("click", () => {
          const key = td.getAttribute("data-key");
          const current = hoursMap[key];
          const input = prompt(`Enter hours for ${key} (blank to clear)`, current != null ? String(current) : "");
          if (input === null) return; // user cancelled
          const val = input.trim();
          if (val === ""){
            setUserHours(sessionEmail, key, null);
          } else {
            const num = Number(val);
            if (Number.isNaN(num) || num < 0){ alert("Please enter a positive number (e.g., 2 or 3.5)."); return; }
            setUserHours(sessionEmail, key, num);
          }
          drawCalendar();
        });
      });
    }

    // ========== UI State ==========
    function renderAppState(){
      const email = getVolunteerSession();
      const regCard = $("#volunteerRegisterCard");
      const loginCard = $("#volunteerLoginCard");
      const hoursCard = $("#hoursCard");

      if (email){
        // show calendar
        const vol = readVolunteers().find(v => (v.email||"").toLowerCase() === email);
        whoAmI.textContent = vol ? `${vol.name} • ${email}` : email;
        hide(regCard);
        hide(loginCard);
        show(hoursCard);

        // set current month if first load
        const now = new Date();
        if (viewYear == null){ viewYear = now.getFullYear(); viewMonth = now.getMonth(); }
        drawCalendar();
      } else {
        // show register and login, hide calendar
        show(regCard);
        show(loginCard);
        hide(hoursCard);
      }
    }

    // ========== Init ==========
    (function init(){
      // Hide empty alerts by default
      setAlert($("#volMsg"), "");
      setAlert($("#loginMsg"), "");

      renderAppState();
    })();
  </script>
</body>
</html>
