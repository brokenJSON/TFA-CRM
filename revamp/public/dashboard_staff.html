<!DOCTYPE HTML>
<html>
  <head>
    <title>TFA – Staff Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/theme-tfa.css" />
  </head>
  <body class="is-preload">

    <div id="wrapper">
      <!-- Main -->
      <div id="main">
        <div class="inner">
          <!-- Header -->
          <header id="header">
            <a href="index.html" class="logo"><strong>Staff Dashboard</strong></a>
            <ul class="icons">
              <li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
              <li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
              <li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
              <li><span id="userEmail" style="margin-right:1em;color:#7f888f;"></span></li>
              <li><a href="#" id="signOutBtn" class="button small" style="margin:0;">Sign Out</a></li>
            </ul>
          </header>

          <!-- Content -->
          <section>
            <header class="main">
              <h1>Volunteers</h1>
              <p>Manage the volunteer directory, track totals, and export data.</p>
            </header>

            <!-- KPI Cards -->
            <div class="row gtr-50 gtr-uniform">
              <div class="col-4 col-12-small">
                <div class="box" style="border-left:6px solid var(--tfa-primary);">
                  <h3 style="margin-bottom:.25em;">Active volunteers</h3>
                  <div id="kpi-active" style="font-size:2rem;font-weight:700;color:var(--tfa-primary);">0</div>
                </div>
              </div>
              <div class="col-4 col-12-small">
                <div class="box" style="border-left:6px solid var(--tfa-secondary);">
                  <h3 style="margin-bottom:.25em;">New this month</h3>
                  <div id="kpi-new" style="font-size:2rem;font-weight:700;color:var(--tfa-secondary);">0</div>
                </div>
              </div>
              <div class="col-4 col-12-small">
                <div class="box" style="border-left:6px solid #3d4449;">
                  <h3 style="margin-bottom:.25em;">Total hours (matched)</h3>
                  <div id="kpi-hours" style="font-size:2rem;font-weight:700;color:#3d4449;">0.00</div>
                </div>
              </div>
            </div>

            <hr class="major" />

            <!-- Controls -->
            <div class="box alt">
              <div class="row gtr-25">
                <div class="col-3 col-12-small">
                  <input type="text" id="searchBox" placeholder="Search name/email/phone…" />
                </div>
                <div class="col-4 col-12-small">
                  <select id="filterStatus">
                    <option value="">All statuses</option>
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                  </select>
                </div>
                <div class="col-5 col-12-small align-right">
                  <ul class="actions">
                    <li><a href="#" class="button" id="btnExport">Export CSV</a></li>
                    <li>
                      <label for="csvFile" class="button">Import CSV</label>
                      <input type="file" id="csvFile" accept=".csv" style="display:none;" />
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Add Volunteer -->
            <div class="box">
              <h3 class="tfa-accent-underline" style="margin-top:0;">Add / Edit Volunteer</h3>
              <form id="volForm">
                <input type="hidden" id="volId" />
                <div class="row gtr-uniform">
                  <div class="col-4 col-12-xsmall">
                    <label for="volName">Full name</label>
                    <input type="text" id="volName" required placeholder="e.g., Alex Johnson" />
                  </div>
                  <div class="col-4 col-12-xsmall">
                    <label for="volEmail">Email</label>
                    <input type="email" id="volEmail" required placeholder="alex@example.org" />
                  </div>
                  <div class="col-4 col-12-xsmall">
                    <label for="volPhone">Phone</label>
                    <input type="tel" id="volPhone" placeholder="(555) 123-4567" />
                  </div>
                  <div class="col-4 col-12-xsmall">
                    <label for="volStatus">Status</label>
                    <select id="volStatus">
                      <option>Active</option>
                      <option>Inactive</option>
                    </select>
                  </div>
                  <div class="col-4 col-12-xsmall">
                    <label for="volJoin">Join date</label>
                    <input type="date" id="volJoin" />
                  </div>
                  <div class="col-12">
                    <label for="volNotes">Notes</label>
                    <textarea id="volNotes" rows="2" placeholder="Optional notes, skills, availability"></textarea>
                  </div>
                  <div class="col-12">
                    <ul class="actions">
                      <li><button type="submit" class="button primary" id="btnSave">Save</button></li>
                      <li><button type="button" class="button" id="btnReset">Reset</button></li>
                    </ul>
                  </div>
                </div>
              </form>
            </div>

            <!-- Directory -->
            <div class="table-wrapper">
              <table id="volTable" class="alt">
                <thead>
                  <tr>
                    <th data-sort="name" class="sortable">Name</th>
                    <th data-sort="email" class="sortable">Email</th>
                    <th>Phone</th>
                    <th data-sort="status" class="sortable">Status</th>
                    <th data-sort="joinDate" class="sortable">Joined</th>
                    <th data-sort="hours" class="sortable">Hours (matched)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <ul class="pagination" id="pager" style="margin-top:1em;"></ul>
          </section>
        </div>
      </div>

      <!-- Sidebar -->
      <div id="sidebar">
        <div class="inner">
          <!-- Search -->
          <section id="search" class="alt">
            <form method="post" action="#">
              <input type="text" placeholder="Quick search…" oninput="document.getElementById('searchBox').value=this.value;window._refresh();" />
            </form>
          </section>

          <!-- Menu -->
          <nav id="menu">
            <header class="major">
              <h2>Navigation</h2>
            </header>
            <ul>
              <li><a href="index.html">Homepage</a></li>
              <li><a href="dashboard_staff.html" class="tfa-current">Staff Dashboard</a></li>
              <li><a href="events.html">Events</a></li>
              <li><a href="reports.html">Reports</a></li>
              <li><a href="campaigns.html">Campaigns</a></li>
            </ul>
          </nav>

          <!-- Help -->
          <section>
            <header class="major">
              <h2>Need Help?</h2>
            </header>
            <p>Email <a href="#">support@thefamilyadvocates.org</a> if you have trouble managing volunteers.</p>
          </section>

          <!-- Footer -->
          <footer id="footer">
            <p class="copyright">&copy; The Family Advocates. All rights reserved.</p>
          </footer>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/auth.js"></script>

    <!-- Staff Logic -->
    <script>
      // Require admin or staff authentication (both can access this page)
      TFA_AUTH.requireAdmin();
    </script>
    <script>
      (function(){
        const STORAGE_VOLUNTEERS = 'tfa_volunteers';
        const STORAGE_LOGS = 'tfa_hours';
        const PAGE_SIZE = 10;

        // State
        let volunteers = load(STORAGE_VOLUNTEERS) || seed();
        let logs = load(STORAGE_LOGS) || [];
        let sortKey = 'name', sortDir = 'asc', page = 1;

        // Elements
        const tbody = document.querySelector('#volTable tbody');
        const pager = document.getElementById('pager');
        const searchBox = document.getElementById('searchBox');
        const filterStatus = document.getElementById('filterStatus');
        const kpiActive = document.getElementById('kpi-active');
        const kpiNew = document.getElementById('kpi-new');
        const kpiHours = document.getElementById('kpi-hours');

        // Form
        const volForm = document.getElementById('volForm');
        const volId = document.getElementById('volId');
        const volName = document.getElementById('volName');
        const volEmail = document.getElementById('volEmail');
        const volPhone = document.getElementById('volPhone');
        const volStatus = document.getElementById('volStatus');
        const volJoin = document.getElementById('volJoin');
        const volNotes = document.getElementById('volNotes');
        const btnReset = document.getElementById('btnReset');

        // CSV
        const btnExport = document.getElementById('btnExport');
        const csvFile = document.getElementById('csvFile');

        // Init
        attachSortHandlers();
        refresh();

        // Expose refresh for sidebar quick search
        window._refresh = refresh;

        // Handlers
        searchBox.addEventListener('input', ()=>{ page = 1; refresh(); });
        filterStatus.addEventListener('change', ()=>{ page = 1; refresh(); });

        volForm.addEventListener('submit', function(e){
          e.preventDefault();
          const id = volId.value || cryptoId();
          const v = {
            id,
            name: volName.value.trim(),
            email: volEmail.value.trim().toLowerCase(),
            phone: volPhone.value.trim(),
            role: 'Volunteer', // Staff can only create volunteers
            // Capitalize first letter of status to match database ('Active', 'Inactive', etc.)
            status: (volStatus.value || 'Active').charAt(0).toUpperCase() + (volStatus.value || 'Active').slice(1).toLowerCase(),
            joinDate: volJoin.value || todayISO(),
            notes: volNotes.value.trim()
          };
          if(!v.name || !v.email){ alert('Name and email are required.'); return; }

          const existingIdx = volunteers.findIndex(x => x.id === id);
          if(existingIdx >= 0) volunteers[existingIdx] = v;
          else volunteers.unshift(v);
          save(STORAGE_VOLUNTEERS, volunteers);
          resetForm();
          refresh();
        });

        btnReset.addEventListener('click', function(){
          resetForm();
        });

        btnExport.addEventListener('click', function(e){
          e.preventDefault();
          const csv = toCSV(volunteers);
          download('tfa_volunteers.csv', csv, 'text/csv');
        });

        csvFile.addEventListener('change', function(){
          const file = this.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try{
              const rows = parseCSV(reader.result);
              const mapped = rows.map(r => ({
                id: r.id || cryptoId(),
                name: r.name || '',
                email: (r.email || '').toLowerCase(),
                phone: r.phone || '',
                role: 'Volunteer', // Staff can only import volunteers
                status: r.status || 'Active',
                joinDate: r.joinDate || todayISO(),
                notes: r.notes || ''
              })).filter(v => v.name && v.email);
              mapped.forEach(m => {
                const i = volunteers.findIndex(v => v.email === m.email);
                if(i>=0) volunteers[i] = {...volunteers[i], ...m};
                else volunteers.push(m);
              });
              save(STORAGE_VOLUNTEERS, volunteers);
              this.value = '';
              refresh();
              alert('Import complete.');
            }catch(err){
              alert('CSV import failed: ' + err.message);
            }
          };
          reader.readAsText(file);
        });

        // Functions
        function refresh(){
          const hoursByEmail = {};
          try {
            logs.forEach(l => {
              const em = (l.volunteerEmail || '').toLowerCase();
              if(!em) return;
              hoursByEmail[em] = (hoursByEmail[em] || 0) + (Number(l.hours)||0);
            });
          } catch(_){}

          // Staff dashboard: Only show Volunteers (exclude Staff and Admin accounts)
          const volunteersOnly = volunteers.filter(v => {
            const role = (v.role || '').toLowerCase();
            return role === 'volunteer';
          });

          // Status is capitalized in database ('Active', 'Inactive', etc.)
          const activeCount = volunteersOnly.filter(v => {
            const status = v.status || 'Active';
            return status === 'Active';
          }).length;
          kpiActive.textContent = activeCount;
          
          const now = new Date(), y = now.getFullYear(), m = now.getMonth();
          const newThisMonth = volunteersOnly.filter(v => {
            if (!v.joinDate) return false;
            const d = new Date(v.joinDate);
            return d.getFullYear() === y && d.getMonth() === m;
          }).length;
          kpiNew.textContent = newThisMonth;
          
          // Use total_hours from API if available, otherwise fall back to hoursByEmail
          const totalHours = volunteersOnly.reduce((s, v) => {
            // API returns total_hours field
            if (v.total_hours !== undefined && v.total_hours !== null) {
              return s + Number(v.total_hours);
            }
            // Fallback to hoursByEmail if total_hours not available
            return s + (hoursByEmail[(v.email || '').toLowerCase()] || 0);
          }, 0);
          kpiHours.textContent = totalHours.toFixed(2);

          let list = volunteersOnly.map(v => ({
            ...v,
            // Use total_hours from API if available, otherwise fall back to hoursByEmail
            hours: (v.total_hours !== undefined && v.total_hours !== null) 
              ? Number(v.total_hours) 
              : (hoursByEmail[(v.email || '').toLowerCase()] || 0)
          }));

          const q = searchBox.value.trim().toLowerCase();
          if(q){
            list = list.filter(v =>
              v.name.toLowerCase().includes(q) ||
              v.email.toLowerCase().includes(q) ||
              (v.phone||'').toLowerCase().includes(q)
            );
          }
          if(filterStatus.value) {
            // Status comparison (both are capitalized)
            list = list.filter(v => (v.status || 'Active') === filterStatus.value);
          }

          list.sort((a,b)=> {
            const A = (a[sortKey]||''); const B = (b[sortKey]||'');
            if(sortKey==='joinDate'){ return (new Date(A)-new Date(B))*(sortDir==='asc'?1:-1); }
            if(sortKey==='hours'){ return ((a.hours||0)-(b.hours||0))*(sortDir==='asc'?1:-1); }
            return String(A).localeCompare(String(B))*(sortDir==='asc'?1:-1);
          });

          const total = list.length;
          const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
          if(page > pages) page = pages;
          const start = (page-1)*PAGE_SIZE;
          const view = list.slice(start, start + PAGE_SIZE);

          tbody.innerHTML = view.map(v => `
            <tr>
              <td>${escapeHtml(v.name)}</td>
              <td>${escapeHtml(v.email)}</td>
              <td>${escapeHtml(v.phone||'')}</td>
              <td>${escapeHtml(v.status)}</td>
              <td>${v.joinDate ? escapeHtml(fmtDate(v.joinDate)) : ''}</td>
              <td>${(v.hours||0).toFixed(2)}</td>
              <td class="align-right">
                <a href="#" class="button small" onclick="return _edit('${v.id}');">Edit</a>
                <a href="#" class="button small" onclick="return _del('${v.id}');">Delete</a>
              </td>
            </tr>
          `).join('');

          pager.innerHTML = renderPager(page, pages);
          pager.querySelectorAll('a.page').forEach(a=>{
            a.addEventListener('click', (e)=>{ e.preventDefault(); page = Number(a.dataset.p); refresh(); });
          });
          pager.querySelectorAll('a.button').forEach(a=>{
            a.addEventListener('click', (e)=>{
              e.preventDefault();
              const dir = a.dataset.dir;
              page = Math.max(1, Math.min(pages, page + (dir==='next'?1:-1)));
              refresh();
            });
          });
        }

        function renderPager(p, pages){
          const items = [];
          items.push(`<li>${p===1?'<span class="button disabled">Prev</span>':'<a href="#" class="button" data-dir="prev">Prev</a>'}</li>`);
          for(let i=1;i<=pages;i++){
            if(i===p) items.push(`<li><a href="#" class="page active" data-p="${i}">${i}</a></li>`);
            else if(i===1 || i===pages || Math.abs(i-p)<=1)
              items.push(`<li><a href="#" class="page" data-p="${i}">${i}</a></li>`);
            else if(items[items.length-1] !== '<li><span>&hellip;</span></li>')
              items.push('<li><span>&hellip;</span></li>');
          }
          items.push(`<li>${p===pages?'<span class="button disabled">Next</span>':'<a href="#" class="button" data-dir="next">Next</a>'}</li>`);
          return items.join('');
        }

        function attachSortHandlers(){
          document.querySelectorAll('th.sortable').forEach(th=>{
            th.style.cursor = 'pointer';
            th.addEventListener('click', ()=>{
              const key = th.getAttribute('data-sort');
              if(sortKey === key) sortDir = (sortDir==='asc'?'desc':'asc');
              else { sortKey = key; sortDir='asc'; }
              refresh();
            });
          });
        }

        function _edit(id){
          const v = volunteers.find(x=>x.id===id);
          if(!v) return false;
          volId.value = v.id;
          volName.value = v.name || '';
          volEmail.value = v.email || '';
          volPhone.value = v.phone || '';
          // Status is already capitalized in database
          volStatus.value = v.status || 'Active';
          volJoin.value = v.joinDate ? iso(v.joinDate) : '';
          volNotes.value = v.notes || '';
          window.scrollTo({top: volForm.offsetTop - 80, behavior: 'smooth'});
          return false;
        }

        function _del(id){
          if(!confirm('Delete this volunteer?')) return false;
          volunteers = volunteers.filter(v=>v.id!==id);
          save(STORAGE_VOLUNTEERS, volunteers);
          refresh();
          return false;
        }

        function resetForm(){
          volId.value = '';
          volForm.reset();
          volStatus.value = 'Active';
          volJoin.value = '';
        }

        // Utils
        function load(k){ try{return JSON.parse(localStorage.getItem(k));}catch(_){return null;} }
        function save(k,v){ try{localStorage.setItem(k, JSON.stringify(v));}catch(_){/*noop*/} }
        function cryptoId(){ try{ return crypto.getRandomValues(new Uint32Array(2)).join('')+Date.now().toString(36);}catch(_){ return Math.random().toString(16).slice(2)+Date.now().toString(36);} }
        function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
        function iso(d){ const dt=new Date(d); dt.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
        function fmtDate(d){ return new Date(d).toLocaleDateString(); }
        function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

        function toCSV(arr){
          const cols = ['id','name','email','phone','status','joinDate','notes'];
          const header = cols.join(',');
          const lines = arr.map(o => cols.map(k => csvCell(o[k])).join(','));
          return [header].concat(lines).join('\\n');
        }
        function csvCell(v){
          if(v==null) return '';
          const s = String(v).replace(/"/g,'""');
          if(/[",\\n]/.test(s)) return '"' + s + '"';
          return s;
        }
        function parseCSV(text){
          const lines = text.split(/\\r?\\n/).filter(Boolean);
          if(!lines.length) return [];
          const headers = splitCSVLine(lines[0]).map(h=>h.trim());
          return lines.slice(1).map(line=>{
            const cells = splitCSVLine(line);
            const obj = {};
            headers.forEach((h,i)=> obj[h]=cells[i]||'');
            return obj;
          });
        }
        function splitCSVLine(line){
          const out = []; let cur = '', inQ=false;
          for(let i=0;i<line.length;i++){
            const ch=line[i];
            if(inQ){
              if(ch === '"'){
                if(line[i+1]==='"'){ cur+='"'; i++; } else inQ=false;
              } else cur += ch;
            } else {
              if(ch === ','){ out.push(cur); cur=''; }
              else if(ch === '"'){ inQ=true; }
              else cur += ch;
            }
          }
          out.push(cur);
          return out;
        }

        function seed(){
          return [
            { id: cryptoId(), name:'Jordan Smith', email:'jordan@example.org', phone:'555-201-1000', role:'Volunteer', status:'Active', joinDate: iso(new Date()), notes:'' },
            { id: cryptoId(), name:'Priya Patel', email:'priya@example.org', phone:'555-201-1100', role:'Volunteer', status:'Active', joinDate: iso(new Date()), notes:'Food pantry shift lead' }
          ];
        }

        window._edit = _edit;
        window._del = _del;
      })();
    </script>
  </body>
</html>

