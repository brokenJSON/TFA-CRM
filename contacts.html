<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TFA CRM – Contacts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="contacts.css" />
</head>
<body>
  <header class="brand-bar">
    <div class="container">
      <div class="brand">
        <!-- swap for PNG if you want: <img src="assets/images/logo.png" class="logo" alt="The Family Advocates logo"> -->
        <div class="logo">TFA</div>
        <div>
          <div style="font-weight:800">The Family Advocates</div>
          <small>Contacts</small>
        </div>
      </div>
      <div id="topNav" class="nav" style="display:none">
        <div>
          <a href="dashboard.html">Dashboard</a>
          <a href="contacts.html">Contacts</a>
          <a href="volunteer-hours.html">Volunteer Hours</a>
          <a href="#" id="aboutLink">About</a>
        </div>
        <div>
          <button class="logout" onclick="logout()">Log Out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="shell">
    <!-- CONTACT FORM -->
    <section class="card">
      <h2>Contact Editor <span id="editFlag" class="tag">Editing</span></h2>
      <form id="contactForm" autocomplete="off">
        <div class="row">
          <div>
            <label for="cName">Full Name</label>
            <input id="cName" required placeholder="Jane Doe"/>
          </div>
          <div>
            <label for="cRole">Type</label>
            <select id="cRole" required>
              <option>Participant</option><option>Donor</option>
              <option>Volunteer</option><option>Partner</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="cEmail">Email</label>
            <input id="cEmail" type="email" placeholder="jane@example.org"/>
          </div>
          <div>
            <label for="cPhone">Phone</label>
            <input id="cPhone" placeholder="(555) 123-4567"/>
          </div>
        </div>
        <label for="cTags">Tags (comma-separated)</label>
        <input id="cTags" placeholder="donor, monthly, 2025 gala"/>
        <label for="cNotes">Notes</label>
        <textarea id="cNotes" placeholder="Background, interests, preferences…"></textarea>

        <div class="actions">
          <button class="btn primary" type="submit">Save</button>
          <button class="btn ghost" type="button" id="resetBtn">Reset</button>
          <button class="btn danger" type="button" id="deleteBtn" title="Delete current contact">Delete</button>
        </div>
      </form>
    </section>

    <!-- TOOLBAR -->
    <section class="card">
      <h2>Contacts</h2>
      <div class="row" style="margin-bottom:10px">
        <input id="search" placeholder="Search name, email, phone, tag…"/>
        <select id="roleFilter">
          <option value="">All types</option>
          <option>Participant</option><option>Donor</option><option>Volunteer</option><option>Partner</option>
        </select>
        <input id="csvInput" type="file" accept=".csv" title="Import CSV"/>
        <button class="btn ghost" id="importBtn" title="Import CSV">Import</button>
        <button class="btn ghost" id="exportBtn" title="Export JSON">Export</button>
        <button class="btn danger" id="clearBtn" title="Delete ALL contacts">Clear All</button>
      </div>
      <div id="tableWrap"></div>
    </section>
  </main>

  <script>
    // ==== Session guard (same key as your other pages) ====
    const LS = { session:"tfa_session", contacts:"tfa_contacts_v1" };
    if(!localStorage.getItem(LS.session)){
      alert("Please log in first.");
      window.location.href = "main.html";
    } else {
      // Show navigation tabs after login
      const topNav = document.getElementById("topNav");
      if(topNav) topNav.style.display = "flex";
    }

    // ==== Helpers ====
    const $ = s => document.querySelector(s);
    const uid = () => Math.random().toString(36).slice(2,9);
    const esc = s => String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

    function logout(){ localStorage.removeItem(LS.session); window.location.href = "main.html"; }
    
    // Make logout function global
    window.logout = logout;

    function readContacts(){ try{return JSON.parse(localStorage.getItem(LS.contacts))||[]}catch{return[]} }
    function writeContacts(arr){ localStorage.setItem(LS.contacts, JSON.stringify(arr)); render(); }

    // ==== State ====
    let editingId = null;

    // ==== Form wiring ====
    const form = $("#contactForm");
    const resetBtn = $("#resetBtn");
    const deleteBtn = $("#deleteBtn");
    const editFlag = $("#editFlag");

    form.addEventListener("submit", e=>{
      e.preventDefault();
      const item = {
        name: $("#cName").value.trim(),
        role: $("#cRole").value,
        email: $("#cEmail").value.trim(),
        phone: $("#cPhone").value.trim(),
        tags: $("#cTags").value.split(",").map(s=>s.trim()).filter(Boolean),
        notes: $("#cNotes").value.trim(),
        updatedAt: Date.now()
      };
      if(!item.name){ alert("Name is required."); return }
      const list = readContacts();
      if(editingId){
        const idx = list.findIndex(x=>x.id===editingId);
        if(idx>-1) list[idx] = {...list[idx], ...item};
        editingId = null; editFlag.style.display="none";
      } else {
        list.push({ id: uid(), ...item });
      }
      writeContacts(list);
      form.reset();
      $("#cName").focus();
    });

    resetBtn.addEventListener("click", ()=>{
      editingId = null; editFlag.style.display="none"; form.reset(); $("#cName").focus();
    });

    deleteBtn.addEventListener("click", ()=>{
      if(!editingId){ alert("No contact selected for deletion."); return }
      if(!confirm("Delete this contact?")) return;
      writeContacts(readContacts().filter(x=>x.id!==editingId));
      editingId = null; editFlag.style.display="none"; form.reset();
    });

    // ==== Table + filters ====
    const search = $("#search");
    const roleFilter = $("#roleFilter");
    search.addEventListener("input", render);
    roleFilter.addEventListener("change", render);

    function startEdit(id){
      const c = readContacts().find(x=>x.id===id);
      if(!c) return;
      editingId = id; editFlag.style.display="inline-block";
      $("#cName").value = c.name||"";
      $("#cRole").value = c.role||"Participant";
      $("#cEmail").value = c.email||"";
      $("#cPhone").value = c.phone||"";
      $("#cTags").value = (c.tags||[]).join(", ");
      $("#cNotes").value = c.notes||"";
      window.scrollTo({top: form.offsetTop - 10, behavior:"smooth"});
    }

    function remove(id){
      if(!confirm("Delete this contact?")) return;
      writeContacts(readContacts().filter(x=>x.id!==id));
      if(editingId===id){ editingId=null; editFlag.style.display="none"; form.reset(); }
    }

    function render(){
      const q = (search.value||"").toLowerCase();
      const role = roleFilter.value;
      const data = readContacts().filter(c=>{
        const blob = `${c.name} ${c.email} ${c.phone} ${c.role} ${(c.tags||[]).join(" ")} ${c.notes||""}`.toLowerCase();
        const passQ = blob.includes(q);
        const passR = !role || c.role===role;
        return passQ && passR;
      }).sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      const wrap = $("#tableWrap");
      if(data.length===0){
        wrap.innerHTML = `<div class="empty">No contacts yet. Use the form above or Import CSV.</div>`;
        return;
      }

      wrap.innerHTML = `
        <table>
          <thead><tr>
            <th style="width:22%">Name</th>
            <th style="width:12%">Type</th>
            <th style="width:22%">Email</th>
            <th style="width:16%">Phone</th>
            <th>Tags</th>
            <th style="width:150px">Actions</th>
          </tr></thead>
          <tbody>
            ${data.map(r=>`
              <tr>
                <td>${esc(r.name||"")}</td>
                <td><span class="tag">${esc(r.role||"")}</span></td>
                <td>${esc(r.email||"")}</td>
                <td>${esc(r.phone||"")}</td>
                <td>${(r.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join(" ")}</td>
                <td>
                  <button class="btn ghost" onclick="startEdit('${r.id}')">Edit</button>
                  <button class="btn danger" onclick="remove('${r.id}')">Delete</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    // ==== Import / Export / Clear ====
    const csvInput = $("#csvInput");
    $("#importBtn").addEventListener("click", ()=> csvInput.click());
    csvInput.addEventListener("change", importCSV);
    $("#exportBtn").addEventListener("click", exportJSON);
    $("#clearBtn").addEventListener("click", ()=>{
      if(confirm("Delete ALL contacts?")){ writeContacts([]); form.reset(); editingId=null; editFlag.style.display="none"; }
    });

    function exportJSON(){
      const data = JSON.stringify(readContacts(), null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "tfa-contacts.json"; a.click();
      URL.revokeObjectURL(url);
    }

    function importCSV(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.split(/\r?\n/).filter(Boolean);
        if(lines.length===0){ alert("Empty CSV"); return; }
        const headers = lines[0].split(",").map(s=>s.trim().toLowerCase());
        const out = readContacts();
        for(let i=1;i<lines.length;i++){
          const cells = parseCSVLine(lines[i]); // handles commas inside quotes
          const row = {};
          headers.forEach((h,idx)=> row[h] = (cells[idx]||"").trim());
          out.push({
            id: uid(),
            name: row.name || "",
            email: row.email || "",
            phone: row.phone || "",
            role: row.role || "Participant",
            tags: (row.tags||"").split(/[;,]/).map(s=>s.trim()).filter(Boolean),
            notes: row.notes || "",
            updatedAt: Date.now()
          });
        }
        writeContacts(out);
        e.target.value = "";
        alert("Import complete.");
      };
      reader.readAsText(file);
    }

    // Simple CSV parser for a single line (handles quoted fields with commas)
    function parseCSVLine(line){
      const out=[]; let cur=""; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i], nxt=line[i+1];
        if(ch==='\"'){
          if(inQ && nxt==='\"'){ cur+='\"'; i++; }
          else { inQ=!inQ; }
        }else if(ch===',' && !inQ){
          out.push(cur); cur="";
        }else{
          cur+=ch;
        }
      }
      out.push(cur);
      return out;
    }

    // ==== Seed & initial render ====
    (function init(){
      if(readContacts().length===0){
        writeContacts([{ id: uid(), name:"Alex Rivera", role:"Donor", email:"alex@donors.org", phone:"555-0102", tags:["monthly","newsletter"], notes:"Prefers email updates", updatedAt: Date.now() }]);
      } else { render(); }
    })();

    // expose for buttons
    window.startEdit = startEdit;
    window.remove = remove;

  // About link
  const aboutLink = document.getElementById("aboutLink");
  if(aboutLink){
    aboutLink.addEventListener("click", e=>{
      e.preventDefault();
      alert("The Family Advocates CRM Demo\nContacts manager (localStorage)\nFor production, connect to a backend per the Database Schema page.");
    });
  }
  </script>
</body>
</html>
